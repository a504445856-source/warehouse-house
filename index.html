<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ğŸ“¦ Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø¨ÙŠØª</title>
  <style>
    :root{--b:#2563eb;--bg:#f6f7fb;--card:#fff;--br:#e5e7eb;--txt:#111827;}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial;background:var(--bg);color:var(--txt)}
    header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--br);padding:12px 14px;z-index:10}
    header h1{margin:0;font-size:18px;display:flex;gap:8px;align-items:center}
    main{padding:14px;max-width:980px;margin:auto}
    .grid{display:grid;gap:10px}
    @media(min-width:900px){.grid{grid-template-columns: 1.1fr .9fr}}
    .card{background:var(--card);border:1px solid var(--br);border-radius:12px;padding:12px}
    .row{display:grid;gap:8px;grid-template-columns:1fr}
    @media(min-width:560px){.row.two{grid-template-columns:1fr 1fr}.row.three{grid-template-columns:1fr 1fr 1fr}}
    input,select,textarea,button{width:100%;box-sizing:border-box;padding:11px;border-radius:10px;border:1px solid var(--br);font-size:15px;background:#fff}
    textarea{min-height:90px;resize:vertical}
    button{background:var(--b);color:#fff;border:0;font-weight:700;cursor:pointer}
    button.secondary{background:#111827}
    button.light{background:#e5e7eb;color:#111827}
    .muted{color:#6b7280;font-size:13px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .toolbar > *{flex:1}
    .list{display:grid;gap:10px}
    .item{display:grid;gap:10px;border:1px solid var(--br);border-radius:12px;padding:10px;background:#fff}
    @media(min-width:560px){.item{grid-template-columns:110px 1fr}}
    .thumb{width:110px;height:110px;border-radius:10px;border:1px solid var(--br);object-fit:cover;background:#f3f4f6}
    .meta b{font-size:16px}
    .tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .tag{font-size:12px;background:#f3f4f6;border:1px solid var(--br);padding:4px 8px;border-radius:999px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .actions button{flex:1}
    .split{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .pill{font-size:12px;background:#eef2ff;border:1px solid #c7d2fe;color:#1e3a8a;padding:4px 8px;border-radius:999px}
    .warn{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;padding:10px;border-radius:12px}
    .ok{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;padding:10px;border-radius:12px}
    hr{border:0;border-top:1px solid var(--br);margin:10px 0}
  </style>
</head>
<body>
<header>
  <div class="split">
    <h1>ğŸ“¦ Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø¨ÙŠØª</h1>
    <span class="pill" id="statusPill">Ø¬Ø§Ù‡Ø²</span>
  </div>
</header>

<main class="grid">
  <!-- Ø¥Ø¶Ø§ÙØ© -->
  <section class="card">
    <div class="split">
      <b>Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ ØºØ±Ø¶</b>
      <span class="muted" id="editHint">ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¶Ø§ÙØ©</span>
    </div>
    <hr/>

    <div class="row">
      <input id="name" placeholder="Ø§Ø³Ù… Ø§Ù„ØºØ±Ø¶ (Ù…Ø«Ø§Ù„: Ù…ÙÙƒ ÙƒØ¨ÙŠØ±)"/>
    </div>

    <div class="row two">
      <select id="category">
        <option value="">Ø§Ù„ØªØµÙ†ÙŠÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</option>
        <option>Ø£Ø¯ÙˆØ§Øª</option>
        <option>ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option>
        <option>Ø³Ø¨Ø§ÙƒØ©</option>
        <option>ØªÙ†Ø¸ÙŠÙ</option>
        <option>Ù…Ø·Ø¨Ø®</option>
        <option>Ø­Ø¯ÙŠÙ‚Ø©</option>
        <option>Ù‚Ø·Ø¹ ØºÙŠØ§Ø±</option>
        <option>Ø£Ø®Ø±Ù‰</option>
      </select>

      <select id="shelf">
        <option value="">Ø±Ù‚Ù… Ø§Ù„Ø±Ù *</option>
      </select>
    </div>

    <div class="row three">
      <select id="side">
        <option value="">Ø§Ù„Ø¬Ù‡Ø©</option>
        <option>ÙŠÙ…ÙŠÙ†</option>
        <option>ÙŠØ³Ø§Ø±</option>
        <option>ÙˆØ³Ø·</option>
      </select>
      <select id="level">
        <option value="">Ø§Ù„Ù…Ø³ØªÙˆÙ‰</option>
        <option>Ø¹Ù„ÙˆÙŠ</option>
        <option>ÙˆØ³Ø·</option>
        <option>Ø³ÙÙ„ÙŠ</option>
      </select>
      <input id="zone" placeholder="Ù…Ù†Ø·Ù‚Ø©/Ù‚Ø³Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"/>
    </div>

    <div class="row">
      <textarea id="notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ù…Ø«Ø§Ù„: Ø¯Ø§Ø®Ù„ ØµÙ†Ø¯ÙˆÙ‚ Ø£Ø³ÙˆØ¯)"></textarea>
    </div>

    <div class="row">
      <input type="file" id="img" accept="image/*" capture="environment"/>
      <div class="muted">ØªÙ‚Ø¯Ø± ØªØ±ÙØ¹ ØµÙˆØ±Ø© Ø£Ùˆ ØªÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©.</div>
    </div>

    <div class="actions">
      <button onclick="saveItem()">Ø­ÙØ¸</button>
      <button class="light" onclick="resetForm()">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
      <button class="secondary" onclick="syncNow()">Ù…Ø²Ø§Ù…Ù†Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</button>
    </div>

    <div id="msgBox" style="margin-top:10px"></div>
  </section>

  <!-- Ø¨Ø­Ø«/Ø¹Ø±Ø¶ -->
  <section class="card">
    <div class="split">
      <b>Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø¹Ø±Ø¶</b>
      <span class="muted">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØºØ±Ø§Ø¶: <b id="count">0</b></span>
    </div>
    <hr/>

    <div class="toolbar">
      <input id="q" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª/Ø§Ù„Ù…Ù†Ø·Ù‚Ø©â€¦" oninput="render()"/>
      <select id="filterShelf" onchange="render()">
        <option value="">ÙƒÙ„ Ø§Ù„Ø±ÙÙˆÙ</option>
      </select>
      <select id="filterCat" onchange="render()">
        <option value="">ÙƒÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</option>
        <option>Ø£Ø¯ÙˆØ§Øª</option><option>ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option><option>Ø³Ø¨Ø§ÙƒØ©</option><option>ØªÙ†Ø¸ÙŠÙ</option>
        <option>Ù…Ø·Ø¨Ø®</option><option>Ø­Ø¯ÙŠÙ‚Ø©</option><option>Ù‚Ø·Ø¹ ØºÙŠØ§Ø±</option><option>Ø£Ø®Ø±Ù‰</option>
      </select>
    </div>

    <div class="warn muted" style="margin-top:10px">
      ğŸ”¸ Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© ØªØ­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø¬ÙˆØ§Ù„.  
      Ø¥Ø°Ø§ ØªØ¨ÙŠ ÙƒÙ„ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© ØªØ´ÙˆÙ Ù†ÙØ³ Ø§Ù„Ø£Ø´ÙŠØ§Ø¡ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± **Ù…Ø²Ø§Ù…Ù†Ø©** (ÙˆÙŠØ¨Ù‚Ù‰ ÙŠØ­ØªØ§Ø¬ Ù†Øª ÙˆÙ‚Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©).
    </div>

    <hr/>
    <div class="list" id="list"></div>
  </section>
</main>

<script>
/** ğŸ”— Ø¶Ø¹ Ø±Ø§Ø¨Ø· Apps Script Ù‡Ù†Ø§ (Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ù†Ø¯Ùƒ) */
const API = "https://script.google.com/macros/s/AKfycbzQTPEMSdGe9rcUsVBntVdj_oFG0vZmvHT_EcrZ2ghoS0i8G4NZiSqrB5Tsl3FC5KAd/exec";

/** Ø¥Ø¹Ø¯Ø§Ø¯ Ø±ÙÙˆÙ: Ø¹Ø¯Ù„ Ø§Ù„Ø¹Ø¯Ø¯ Ø­Ø³Ø¨ Ù…Ø³ØªÙˆØ¯Ø¹Ùƒ */
const SHELVES_COUNT = 40; // Ù…Ø«Ø§Ù„: 40 Ø±Ù

let items = [];
let editingId = null;

const $ = (id)=>document.getElementById(id);

function setPill(text, ok=true){
  const p = $("statusPill");
  p.textContent = text;
  p.style.background = ok ? "#ecfdf5" : "#fff7ed";
  p.style.borderColor = ok ? "#a7f3d0" : "#fed7aa";
  p.style.color = ok ? "#065f46" : "#9a3412";
}

function msg(html, kind="ok"){
  $("msgBox").innerHTML = `<div class="${kind}">${html}</div>`;
  setTimeout(()=>{$("msgBox").innerHTML="";}, 4000);
}

function uid(){
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}

function initShelves(){
  const shelfSel = $("shelf");
  const filterSel = $("filterShelf");
  for(let i=1;i<=SHELVES_COUNT;i++){
    const opt1 = document.createElement("option");
    opt1.value = String(i);
    opt1.textContent = `Ø±Ù ${i}`;
    shelfSel.appendChild(opt1);

    const opt2 = document.createElement("option");
    opt2.value = String(i);
    opt2.textContent = `Ø±Ù ${i}`;
    filterSel.appendChild(opt2);
  }
}

function loadLocal(){
  try{
    const raw = localStorage.getItem("warehouse_items_v2");
    items = raw ? JSON.parse(raw) : [];
  }catch(e){ items=[]; }
}

function saveLocal(){
  localStorage.setItem("warehouse_items_v2", JSON.stringify(items));
}

function locText(it){
  const parts = [];
  if(it.shelf) parts.push(`Ø±Ù ${it.shelf}`);
  if(it.side) parts.push(it.side);
  if(it.level) parts.push(it.level);
  if(it.zone) parts.push(`(${it.zone})`);
  return parts.join(" - ") || "Ø¨Ø¯ÙˆÙ† Ù…ÙˆÙ‚Ø¹";
}

async function fileToDataURL(file){
  if(!file) return "";
  return await new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=>resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

function resetForm(){
  editingId = null;
  $("editHint").textContent = "ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¶Ø§ÙØ©";
  $("name").value="";
  $("category").value="";
  $("shelf").value="";
  $("side").value="";
  $("level").value="";
  $("zone").value="";
  $("notes").value="";
  $("img").value="";
  msg("ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„.", "ok");
}

function startEdit(id){
  const it = items.find(x=>x.id===id);
  if(!it) return;
  editingId = id;
  $("editHint").textContent = "ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„";
  $("name").value = it.name||"";
  $("category").value = it.category||"";
  $("shelf").value = it.shelf||"";
  $("side").value = it.side||"";
  $("level").value = it.level||"";
  $("zone").value = it.zone||"";
  $("notes").value = it.notes||"";
  msg("Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸.", "ok");
  window.scrollTo({top:0, behavior:"smooth"});
}

function removeItem(id){
  if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØºØ±Ø¶ØŸ")) return;
  items = items.filter(x=>x.id!==id);
  saveLocal();
  render();
  msg("ØªÙ… Ø§Ù„Ø­Ø°Ù.", "ok");
}

async function saveItem(){
  const name = $("name").value.trim();
  const shelf = $("shelf").value.trim();
  if(!name){ msg("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ØºØ±Ø¶.", "warn"); return; }
  if(!shelf){ msg("Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ø±Ù.", "warn"); return; }

  let imgData = "";
  const f = $("img").files[0];
  if(f){
    imgData = await fileToDataURL(f);
  }

  const payload = {
    id: editingId || uid(),
    name,
    category: $("category").value.trim(),
    shelf,
    side: $("side").value.trim(),
    level: $("level").value.trim(),
    zone: $("zone").value.trim(),
    notes: $("notes").value.trim(),
    img: imgData || (editingId ? (items.find(x=>x.id===editingId)?.img||"") : ""),
    updatedAt: Date.now()
  };

  const idx = items.findIndex(x=>x.id===payload.id);
  if(idx>=0) items[idx]=payload;
  else items.unshift(payload);

  saveLocal();
  render();
  resetForm();
  msg("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ âœ…", "ok");
}

function render(){
  const q = $("q").value.trim().toLowerCase();
  const fs = $("filterShelf").value.trim();
  const fc = $("filterCat").value.trim();

  let filtered = items.slice();
  if(fs) filtered = filtered.filter(x=>String(x.shelf)===String(fs));
  if(fc) filtered = filtered.filter(x=>(x.category||"")===fc);
  if(q){
    filtered = filtered.filter(x=>{
      const hay = `${x.name||""} ${x.notes||""} ${x.zone||""} ${x.side||""} ${x.level||""} ${x.category||""}`.toLowerCase();
      return hay.includes(q);
    });
  }

  $("count").textContent = String(filtered.length);
  const box = $("list");
  box.innerHTML = "";

  if(filtered.length===0){
    box.innerHTML = `<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØºØ±Ø§Ø¶ Ù…Ø·Ø§Ø¨Ù‚Ø©. Ø¬Ø±Ù‘Ø¨ Ø¨Ø­Ø« Ù…Ø®ØªÙ„Ù Ø£Ùˆ Ø£Ø¶Ù ØºØ±Ø¶ Ø¬Ø¯ÙŠØ¯.</div>`;
    return;
  }

  for(const it of filtered){
    const img = it.img ? `<img class="thumb" src="${it.img}" alt="ØµÙˆØ±Ø©">` : `<div class="thumb"></div>`;
    const tags = [
      it.category ? `<span class="tag">${it.category}</span>` : "",
      it.shelf ? `<span class="tag">Ø±Ù ${it.shelf}</span>` : "",
      it.side ? `<span class="tag">${it.side}</span>` : "",
      it.level ? `<span class="tag">${it.level}</span>` : "",
      it.zone ? `<span class="tag">${it.zone}</span>` : ""
    ].join("");

    box.innerHTML += `
      <div class="item">
        <div>${img}</div>
        <div class="meta">
          <b>${escapeHtml(it.name||"")}</b>
          <div class="muted" style="margin-top:4px">ğŸ“ ${escapeHtml(locText(it))}</div>
          ${it.notes ? `<div style="margin-top:6px">${escapeHtml(it.notes)}</div>` : ""}
          <div class="tags">${tags}</div>
          <div class="actions">
            <button class="light" onclick="startEdit('${it.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="secondary" onclick="removeItem('${it.id}')">Ø­Ø°Ù</button>
          </div>
        </div>
      </div>
    `;
  }
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}

/** Ù…Ø²Ø§Ù…Ù†Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©) */
async function syncNow(){
  setPill("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©â€¦", false);
  try{
    // 1) Ø¬Ù„Ø¨ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± (Ù„Ùˆ ÙÙŠÙ‡ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø­Ø¯Ø«)
    const r = await fetch(API, {cache:"no-store"});
    const remote = await r.json();
    const remoteItems = Array.isArray(remote.items) ? remote.items : [];

    // 2) Ø¯Ù…Ø¬: Ø§Ù„Ø£Ø­Ø¯Ø« ÙŠÙÙˆØ²
    const map = new Map();
    for(const it of remoteItems) map.set(it.id, it);
    for(const it of items){
      const old = map.get(it.id);
      if(!old || (it.updatedAt||0) > (old.updatedAt||0)) map.set(it.id, it);
    }
    items = Array.from(map.values()).sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));
    saveLocal();
    render();

    // 3) Ø¯ÙØ¹ Ù„Ù„Ù€ API (ÙŠØ­ÙØ¸ Ø¹Ù†Ø¯ÙƒÙ… ÙÙŠ Google)
    await fetch(API,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ items })
    });

    setPill("ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© âœ…", true);
    msg("ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ…", "ok");
  }catch(e){
    console.error(e);
    setPill("ÙØ´Ù„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©", false);
    msg("ÙØ´Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©. ØªØ£ÙƒØ¯ Ù…Ù† Ø±Ø§Ø¨Ø· Apps Script Ø£Ùˆ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.", "warn");
  }
}

(function boot(){
  initShelves();
  loadLocal();
  render();
  setPill("Ø¬Ø§Ù‡Ø²", true);
})();
</script>
</body>
</html>
